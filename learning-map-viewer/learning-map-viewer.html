<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학습맵 조회 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .search-section {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .radio-item label {
            margin-bottom: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-btn {
            padding: 12px 25px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .search-btn:hover {
            background: #5a6fd8;
        }

        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .results-section {
            padding: 30px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .result-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .result-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .result-title {
            font-size: 1.3rem;
            color: #333;
            font-weight: 600;
        }

        .subject-badge {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }

        .info-value {
            color: #333;
        }

        .skills-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .skill-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .textbook-list {
            margin-top: 10px;
        }

        .textbook-item {
            background: #fff3e0;
            color: #f57c00;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 5px;
            border-left: 3px solid #ff9800;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #f44336;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>학습맵 조회 시스템</h1>
            <p>스테이지 정보를 입력하여 관련 학습맵 정보를 조회하세요</p>
        </div>

        <div class="search-section">
            <div class="form-group">
                <label>조회할 과목 선택</label>
                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="english" name="subject" value="ENG">
                        <label for="english">영어</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="math" name="subject" value="MAT">
                        <label for="math">수학</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="stage">스테이지 정보 입력</label>
                <div class="input-group">
                    <input type="text" id="stage" placeholder="스테이지 값을 입력하세요.">
                    <button class="search-btn" onclick="searchLearningMap()">조회</button>
                </div>
            </div>
        </div>

        <div class="results-section" id="results">
            <div class="no-results">
                과목을 선택하고 스테이지 정보를 입력한 후 조회 버튼을 클릭하세요.
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        // Google API 설정
        const CONFIG = {
            API_KEY: 'AIzaSyCZgLiJnlHHZBqdRpkpO8WvwNcYTNQovw8', // 실제 API 키를 여기에 입력하세요
            DISCOVERY_DOC: 'https://sheets.googleapis.com/$discovery/rest?version=v4',
            DRIVE_DISCOVERY_DOC: 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
            
            // 실제 ID 값들
            MAIN_FOLDER_ID: '1YTMj2DjY3VJrXegktJC9y3xVgXv1CMGl',
            LEARNING_MAP_ENG_ID: '1CzTqGybErp8IlWzZI_3e7WAXOuG9Te1J3322AoDqQ0E',
            LEARNING_MAP_MAT_ID: '1L8e_xx9tRfqJA27v_XpLh7T5XL8lJczYYSGybiaqPrM',
            ACTIVITIES_ENG_FOLDER: '111vXhrUBR58SAX9-9opjYzt0WVYWhbnJ',
            ACTIVITIES_MAT_FOLDER: '1sdKYWQdvR39VdRteWXSnGAL-jFuqp3xu'
        };

        let gapi_initialized = false;

        // Google API 초기화
        async function initializeGapi() {
            if (gapi_initialized) return;
            
            await gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: CONFIG.API_KEY,
                    discoveryDocs: [CONFIG.DISCOVERY_DOC, CONFIG.DRIVE_DISCOVERY_DOC]
                });
                gapi_initialized = true;
                console.log('Google API 초기화 완료');
            });
        }

        // 스프레드시트에서 데이터 읽기
        async function readSpreadsheet(spreadsheetId, range) {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: spreadsheetId,
                    range: range
                });
                return response.result.values;
            } catch (error) {
                console.error('스프레드시트 읽기 오류:', error);
                throw error;
            }
        }

        // 드라이브 폴더에서 파일 목록 가져오기
        async function getFilesInFolder(folderId) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and trashed = false`,
                    fields: 'files(id, name, mimeType)'
                });
                return response.result.files;
            } catch (error) {
                console.error('드라이브 파일 목록 가져오기 오류:', error);
                throw error;
            }
        }

        // 학습맵 조회 메인 함수
        async function searchLearningMap() {
            const subject = document.querySelector('input[name="subject"]:checked');
            const stage = document.getElementById('stage').value.trim();
            const resultsDiv = document.getElementById('results');

            // 입력값 검증
            if (!subject) {
                showError('과목을 선택해주세요.');
                return;
            }

            if (!stage) {
                showError('스테이지 정보를 입력해주세요.');
                return;
            }

            // 로딩 표시
            showLoading();

            try {
                // Google API 초기화
                await initializeGapi();

                // 과목에 따른 액티비티 폴더 찾기
                const activityFolderName = subject.value === 'ENG' ? 'Activities_ENG' : 'Activities_MAT';
                
                // 실제 구현에서는 폴더 구조를 탐색하여 스테이지에 해당하는 데이터를 찾아야 함
                // 여기서는 예시 데이터로 결과를 표시
                const results = await findStageData(subject.value, stage);
                
                if (results.length === 0) {
                    showNoResults();
                } else {
                    displayResults(results, subject.value);
                }

            } catch (error) {
                console.error('조회 중 오류 발생:', error);
                showError('데이터 조회 중 오류가 발생했습니다. API 키 설정을 확인해주세요.');
            }
        }

        // 실제 스테이지 데이터 찾기 함수
        async function findStageData(subject, stage) {
            try {
                console.log(`${subject} 과목의 스테이지 ${stage} 조회 시작`);
                
                // 1. 액티비티 폴더에서 교과서 폴더들 가져오기
                const activityFolderId = subject === 'ENG' ? CONFIG.ACTIVITIES_ENG_FOLDER : CONFIG.ACTIVITIES_MAT_FOLDER;
                const textbookFolders = await getFilesInFolder(activityFolderId);
                
                console.log(`교과서 폴더 ${textbookFolders.length}개 발견`);
                
                let allResults = [];
                
                // 2. 각 교과서 폴더의 액티비티 시트들 조회
                for (const textbookFolder of textbookFolders) {
                    if (textbookFolder.mimeType === 'application/vnd.google-apps.folder') {
                        console.log(`교과서 폴더 조회: ${textbookFolder.name}`);
                        
                        // 교과서 폴더 내 액티비티 시트들 가져오기
                        const activitySheets = await getFilesInFolder(textbookFolder.id);
                        
                        // 3. 각 액티비티 시트에서 스테이지 검색
                        for (const sheet of activitySheets) {
                            if (sheet.mimeType === 'application/vnd.google-apps.spreadsheet') {
                                console.log(`액티비티 시트 조회: ${sheet.name}`);
                                
                                const stageData = await findStageInSheet(sheet.id, stage, textbookFolder.name, sheet.name);
                                if (stageData.length > 0) {
                                    allResults.push(...stageData);
                                }
                            }
                        }
                    }
                }
                
                // 4. 학습맵 코드로 학습맵 정보 조회
                const enrichedResults = await enrichWithLearningMapData(allResults, subject);
                
                console.log(`총 ${enrichedResults.length}개 결과 발견`);
                return formatResultsForDisplay(enrichedResults, subject);
                
            } catch (error) {
                console.error('스테이지 데이터 조회 중 오류:', error);
                throw error;
            }
        }

        // 특정 액티비티 시트에서 스테이지 찾기
        async function findStageInSheet(sheetId, targetStage, textbookName, activityName) {
            try {
                // 시트의 모든 데이터 읽기 (첫 100행으로 제한)
                const range = 'A1:C100';
                const data = await readSpreadsheet(sheetId, range);
                
                if (!data || data.length === 0) {
                    return [];
                }
                
                const results = [];
                
                // 헤더 행 찾기 (#stage, #learningMapCodes, #relatedCurriculums)
                let headerRow = -1;
                let stageCol = -1, codesCol = -1, curriculumCol = -1;
                
                for (let i = 0; i < Math.min(5, data.length); i++) {
                    const row = data[i];
                    for (let j = 0; j < row.length; j++) {
                        if (row[j] && row[j].toString().toLowerCase().includes('stage')) {
                            headerRow = i;
                            stageCol = j;
                        }
                        if (row[j] && row[j].toString().toLowerCase().includes('learningmapcodes')) {
                            codesCol = j;
                        }
                        if (row[j] && row[j].toString().toLowerCase().includes('relatedcurriculums')) {
                            curriculumCol = j;
                        }
                    }
                    if (headerRow >= 0 && stageCol >= 0 && codesCol >= 0 && curriculumCol >= 0) {
                        break;
                    }
                }
                
                if (headerRow === -1) {
                    console.log(`${activityName}: 헤더를 찾을 수 없음`);
                    return [];
                }
                
                // 데이터 행에서 스테이지 검색
                for (let i = headerRow + 1; i < data.length; i++) {
                    const row = data[i];
                    if (row[stageCol] && row[stageCol].toString() === targetStage) {
                        const learningMapCodes = row[codesCol] ? row[codesCol].toString().split('\n') : [];
                        const relatedCurriculum = row[curriculumCol] ? row[curriculumCol].toString() : '';
                        
                        results.push({
                            textbookName: textbookName,
                            activityName: activityName,
                            stage: targetStage,
                            learningMapCodes: learningMapCodes,
                            relatedCurriculum: relatedCurriculum
                        });
                    }
                }
                
                return results;
                
            } catch (error) {
                console.error(`시트 ${sheetId} 조회 중 오류:`, error);
                return [];
            }
        }

        // 학습맵 코드로 학습맵 정보 조회하여 결과 보강
        async function enrichWithLearningMapData(stageResults, subject) {
            if (stageResults.length === 0) {
                return [];
            }
            
            try {
                // 학습맵 스프레드시트 ID
                const learningMapId = subject === 'ENG' ? CONFIG.LEARNING_MAP_ENG_ID : CONFIG.LEARNING_MAP_MAT_ID;
                
                // 수학의 경우 여러 탭 조회
                let learningMapData = [];
                if (subject === 'MAT') {
                    // 수학: 1_2, 3_4, 5_6 탭 모두 조회
                    const tabs = ['1_2!A:F', '3_4!A:F', '5_6!A:F'];
                    for (const tab of tabs) {
                        try {
                            const tabData = await readSpreadsheet(learningMapId, tab);
                            if (tabData && tabData.length > 0) {
                                // 탭 정보 추가
                                const gradeGroup = tab.split('!')[0].replace('_', '-') + '학년군';
                                learningMapData.push(...tabData.map(row => [...row, gradeGroup]));
                            }
                        } catch (error) {
                            console.log(`탭 ${tab} 조회 실패 (존재하지 않을 수 있음)`);
                        }
                    }
                } else {
                    // 영어: 단일 시트
                    learningMapData = await readSpreadsheet(learningMapId, 'A:N');
                }
                
                // 학습맵 인덱스 구성
                const learningMapIndex = buildLearningMapIndex(learningMapData, subject);
                
                // 각 스테이지 결과를 학습맵 정보로 보강
                const enrichedResults = [];
                
                for (const stageResult of stageResults) {
                    for (const code of stageResult.learningMapCodes) {
                        const learningMapInfo = learningMapIndex[code.trim()];
                        if (learningMapInfo) {
                            enrichedResults.push({
                                ...stageResult,
                                learningMapCode: code.trim(),
                                ...learningMapInfo
                            });
                        } else {
                            // 학습맵에서 코드를 찾지 못한 경우에도 기본 정보는 포함
                            enrichedResults.push({
                                ...stageResult,
                                learningMapCode: code.trim(),
                                contentElement: '정보 없음',
                                standardCode: '정보 없음',
                                standardDesc: '정보 없음'
                            });
                        }
                    }
                }
                
                return enrichedResults;
                
            } catch (error) {
                console.error('학습맵 데이터 조회 중 오류:', error);
                // 오류가 발생해도 기본 정보는 반환
                return stageResults.map(result => ({
                    ...result,
                    learningMapCode: result.learningMapCodes.join(', '),
                    contentElement: '조회 실패',
                    standardCode: '조회 실패',
                    standardDesc: '조회 실패'
                }));
            }
        }

        // 학습맵 데이터를 인덱스로 구성
        function buildLearningMapIndex(learningMapData, subject) {
            const index = {};
            
            if (learningMapData.length === 0) {
                return index;
            }
            
            // 헤더 행 스키ップ
            for (let i = 1; i < learningMapData.length; i++) {
                const row = learningMapData[i];
                
                if (subject === 'ENG') {
                    // 영어: content3_id 또는 content4_id로 인덱싱
                    const content3Id = row[0]; // A열: content3_id
                    const content4Id = row[2]; // C열: content4_id
                    
                    const learningMapInfo = {
                        content3: row[1],          // B열: content3
                        content4: row[3],          // D열: content4
                        contentElement: row[1] || row[3], // 3단계 또는 4단계 내용요소
                        standardCode: row[4],      // E열: standards_id
                        standardDesc: row[5],      // F열: standard_desc
                        skills: {
                            alphabet: row[6] === 'TRUE' || row[6] === true,
                            phonics: row[7] === 'TRUE' || row[7] === true,
                            listening: row[8] === 'TRUE' || row[8] === true,
                            reading: row[9] === 'TRUE' || row[9] === true,
                            viewing: row[10] === 'TRUE' || row[10] === true,
                            speaking: row[11] === 'TRUE' || row[11] === true,
                            writing: row[12] === 'TRUE' || row[12] === true,
                            presenting: row[13] === 'TRUE' || row[13] === true
                        }
                    };
                    
                    if (content3Id) index[content3Id] = learningMapInfo;
                    if (content4Id) index[content4Id] = learningMapInfo;
                    
                } else {
                    // 수학: 에누마 ID로 인덱싱
                    const enumaId = row[0]; // A열: 에누마 ID
                    
                    if (enumaId) {
                        index[enumaId] = {
                            enumaId: enumaId,
                            standardCode: row[1],     // B열: standards_id
                            standardDesc: row[2],     // C열: standard_desc
                            contentArea: row[3],      // D열: cc_1_name (내용체계 영역)
                            contentElement: row[4],   // E열: cc_4_name (3단계 내용요소)
                            gradeUnit: row[5],        // F열: gsl_codenames (학년-학기-단원)
                            gradeGroup: row[6] || '정보 없음' // 탭에서 추가된 학년군 정보
                        };
                    }
                }
            }
            
            return index;
        }

        // 결과 데이터를 UI 표시용으로 변환
        function formatResultsForDisplay(results, subject) {
            // 교과서별로 그룹화
            const groupedByTextbook = {};
            
            results.forEach(result => {
                const key = `${result.textbookName}(${result.relatedCurriculum})`;
                if (!groupedByTextbook[key]) {
                    groupedByTextbook[key] = [];
                }
                groupedByTextbook[key].push(result);
            });
            
            // 최종 표시용 데이터 구성
            const displayResults = [];
            
            Object.keys(groupedByTextbook).forEach(textbookKey => {
                const textbookResults = groupedByTextbook[textbookKey];
                const firstResult = textbookResults[0];
                
                // 모든 학습맵 코드와 관련 정보 수집
                const allCodes = textbookResults.map(r => r.learningMapCode).filter(c => c);
                const uniqueCodes = [...new Set(allCodes)];
                
                if (subject === 'ENG') {
                    // 영어: 모든 true인 스킬 수집
                    const allSkills = [];
                    textbookResults.forEach(result => {
                        if (result.skills) {
                            Object.keys(result.skills).forEach(skill => {
                                if (result.skills[skill] && !allSkills.includes(skill)) {
                                    allSkills.push(skill);
                                }
                            });
                        }
                    });
                    
                    displayResults.push({
                        activity: firstResult.activityName,
                        textbooks: [textbookKey],
                        learningMapCode: uniqueCodes.join(', '),
                        contentElement: textbookResults.map(r => r.contentElement).filter(c => c).join(', '),
                        standardCode: textbookResults.map(r => r.standardCode).filter(c => c).join(', '),
                        standardDesc: textbookResults.map(r => r.standardDesc).filter(c => c).join(', '),
                        skills: allSkills
                    });
                    
                } else {
                    // 수학: 학년군, 내용체계 영역 등 정보 수집
                    const gradeGroups = [...new Set(textbookResults.map(r => r.gradeGroup).filter(g => g))];
                    const contentAreas = [...new Set(textbookResults.map(r => r.contentArea).filter(c => c))];
                    const gradeUnits = [...new Set(textbookResults.map(r => r.gradeUnit).filter(g => g))];
                    
                    displayResults.push({
                        activity: firstResult.activityName,
                        textbooks: [textbookKey],
                        learningMapCode: uniqueCodes.join(', '),
                        gradeGroup: gradeGroups.join(', '),
                        contentArea: contentAreas.join(', '),
                        contentElement: textbookResults.map(r => r.contentElement).filter(c => c).join(', '),
                        standardCode: textbookResults.map(r => r.standardCode).filter(c => c).join(', '),
                        standardDesc: textbookResults.map(r => r.standardDesc).filter(c => c).join(', '),
                        gradeUnit: gradeUnits.join(', ')
                    });
                }
            });
            
            return displayResults;
        }

        // 결과 표시
        function displayResults(results, subject) {
            const resultsDiv = document.getElementById('results');
            
            let html = '';
            results.forEach((result, index) => {
                html += createResultCard(result, subject, index + 1);
            });
            
            resultsDiv.innerHTML = html;
        }

        // 결과 카드 생성
        function createResultCard(result, subject, index) {
            const subjectName = subject === 'ENG' ? '영어' : '수학';
            
            let infoItems = `
                <div class="info-item">
                    <div class="info-label">액티비티명</div>
                    <div class="info-value">${result.activity}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">학습맵 코드</div>
                    <div class="info-value">${result.learningMapCode}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">내용 요소</div>
                    <div class="info-value">${result.contentElement}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">성취기준 코드</div>
                    <div class="info-value">${result.standardCode}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">성취기준</div>
                    <div class="info-value">${result.standardDesc}</div>
                </div>
            `;

            // 과목별 추가 정보
            if (subject === 'ENG' && result.skills && result.skills.length > 0) {
                const skillsHtml = result.skills.map(skill => `<span class="skill-tag">${skill}</span>`).join('');
                infoItems += `
                    <div class="info-item">
                        <div class="info-label">영역별 기능</div>
                        <div class="skills-list">${skillsHtml}</div>
                    </div>
                `;
            }

            if (subject === 'MAT') {
                if (result.gradeGroup) {
                    infoItems += `
                        <div class="info-item">
                            <div class="info-label">학년군</div>
                            <div class="info-value">${result.gradeGroup}</div>
                        </div>
                    `;
                }
                if (result.contentArea) {
                    infoItems += `
                        <div class="info-item">
                            <div class="info-label">내용체계 영역</div>
                            <div class="info-value">${result.contentArea}</div>
                        </div>
                    `;
                }
                if (result.gradeUnit) {
                    infoItems += `
                        <div class="info-item">
                            <div class="info-label">학년-학기-단원</div>
                            <div class="info-value">${result.gradeUnit}</div>
                        </div>
                    `;
                }
            }

            // 교과서 정보
            const textbooksHtml = result.textbooks.map(textbook => 
                `<div class="textbook-item">${textbook}</div>`
            ).join('');

            return `
                <div class="result-card">
                    <div class="result-header">
                        <div class="result-title">조회 결과 ${index}</div>
                        <div class="subject-badge">${subjectName}</div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">교과서 및 연관 커리큘럼</div>
                        <div class="textbook-list">${textbooksHtml}</div>
                    </div>
                    
                    <div class="info-grid">
                        ${infoItems}
                    </div>
                </div>
            `;
        }

        // 로딩 표시
        function showLoading() {
            document.getElementById('results').innerHTML = `
                <div class="loading">
                    <p>데이터를 조회하고 있습니다...</p>
                </div>
            `;
        }

        // 결과 없음 표시
        function showNoResults() {
            document.getElementById('results').innerHTML = `
                <div class="no-results">
                    <p>입력하신 스테이지 정보에 해당하는 데이터를 찾을 수 없습니다.</p>
                </div>
            `;
        }

        // 오류 표시
        function showError(message) {
            document.getElementById('results').innerHTML = `
                <div class="error">
                    <p>${message}</p>
                </div>
            `;
        }

        // 엔터키로 검색
        document.getElementById('stage').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchLearningMap();
            }
        });
    </script>
</body>
</html>